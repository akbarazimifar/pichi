parameters:
  name: ''
  url: ''
  dir: ''

steps:
  - bash: >
      curl -LSsf "${{ parameters.url }}" | tar zxf - -C "${WORKSPACE}"
    displayName: "Download and extract ${{ parameters.name }}"
  - ${{ if eq(parameters.name, 'rapidjson') }}:
    - bash: |
        cp -r ${WORKSPACE}/${{ parameters.dir }}/include/${{ parameters.name }} $(SYSROOT)/include
      displayName: "Prepare ${{ parameters.name }} header files"
  - ${{ if eq(parameters.name, 'boost') }}:
    - bash: >
        bash $(Build.SourcesDirectory)/deps-build/boost.sh ${WORKSPACE}/${{ parameters.dir }}
      displayName: "Build and install ${{ parameters.name }}"
  - ${{ if or(eq(parameters.name, 'libmaxminddb'), eq(parameters.name, 'libsodium')) }}:
    - bash: |
        cp -f $(Build.SourcesDirectory)/deps-build/${{ parameters.name }}.cmake \
          ${WORKSPACE}/${{ parameters.dir }}/CMakeLists.txt
      displayName: "Setup cmake arguments for ${{ parameters.name }}"
    - template: ./cross-cmake.yml
      parameters:
        name: ${{ parameters.name }}
        cwd: $(WORKSPACE)/${{ parameters.dir }}/build
        src: $(WORKSPACE)/${{ parameters.dir }}
        extraArgs: -D BUILD_SHARED=OFF
  - ${{ if eq(parameters.name, 'mbedtls') }}:
    - template: ./cross-cmake.yml
      parameters:
        name: ${{ parameters.name }}
        cwd: $(WORKSPACE)/${{ parameters.dir }}/build
        src: $(WORKSPACE)/${{ parameters.dir }}
        extraArgs: -D ENABLE_PROGRAMS=OFF -D ENABLE_TESTING=OFF
